@startuml LoginSequence
skinparam participant {
    BackgroundColor lightblue
    BorderColor black
}

actor User
participant "Auth Route" as Route
participant "Auth Controller" as Controller
participant "User Model" as Model
participant "Database" as DB
participant "JWT Service" as JWT
participant "bcrypt" as Bcrypt

User -> Route: POST /api/v1/auth/login\n{email, password}
Route -> Controller: login(req, res, next)

Controller -> Controller: validate input fields\n(email, password)

alt missing email or password
    Controller -> User: 400 - Please provide email and password
else all fields present
    Controller -> Controller: validate email format\n(regex: /^[^\s@]+@[^\s@]+\.[^\s@]+$/)
    
    alt invalid email format
        Controller -> User: 400 - Please provide valid email address
    else valid email format
        Controller -> Model: findOne({email}).select('+password')
        Model -> DB: query user by email (include password)
        DB -> Model: return user with password
        Model -> Controller: user object with password or null
        
        alt user not found
            Controller -> User: 401 - Invalid credentials
        else user found
            Controller -> Bcrypt: user.matchPassword(enteredPassword)
            Bcrypt -> Bcrypt: bcrypt.compare(enteredPassword, hashedPassword)
            Bcrypt -> Controller: boolean result
            
            alt password doesn't match
                Controller -> User: 401 - Invalid credentials
            else password matches
                Controller -> JWT: user.getSignedJwtToken()
                JWT -> JWT: jwt.sign({id: user._id}, JWT_SECRET, {expiresIn})
                JWT -> Controller: JWT token
                
                Controller -> Controller: calculate cookie expiration\n(JWT_COOKIE_EXPIRE days)
                Controller -> Controller: set cookie options\n{expires, httpOnly, secure}
                
                Controller -> User: 200 - Login successful\nSet-Cookie: token=jwt\n{success: true, token}
            end
        end
    end
end

note right of Controller : "All error responses use\ngeneric 'Invalid credentials'\nmessage for security"

note right of JWT : "Token contains user ID\nand expires based on\nJWT_EXPIRE env variable"

note right of Bcrypt : "Password comparison uses\nbcrypt hashing algorithm\nfor security"

@enduml