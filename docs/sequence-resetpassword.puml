@startuml ResetPasswordSequence
skinparam participant {
    BackgroundColor lightpink
    BorderColor black
}

actor User
participant "Auth Route" as Route
participant "Auth Controller" as Controller
participant "User Model" as Model
participant "Database" as DB
participant "Crypto Service" as Crypto

User -> Route: PUT /api/auth/resetpassword/:token\n{password}
Route -> Controller: resetPassword(req, res, next)

Controller -> Crypto: crypto.createHash("sha256").update(req.params.token)
Crypto -> Controller: hashedToken

Controller -> Model: findOne({resetPasswordToken: hashedToken,\nresetPasswordExpire: {$gt: Date.now()}})
Model -> DB: query user with valid reset token
DB -> Model: return user
Model -> Controller: user object or null

alt token invalid or expired
    Controller -> User: 400 - Invalid or expired token
else token valid
    Controller -> Model: user.password = req.body.password\nuser.resetPasswordToken = undefined\nuser.resetPasswordExpire = undefined
    Model -> Model: hash new password (bcrypt middleware)
    Model -> DB: save user with new password
    DB -> Model: updated user
    Model -> Controller: success
    Controller -> User: 200 - Password reset successful
end

@enduml