@startuml Update Reservation (PUT)

header Restaurant Reservation System Sequence Diagram
footer Page %page% of %lastpage%
title "Update Reservation (PUT)"

participant "Client" as client
participant "<<javaScript>>\n:server" as server
participant "<<router>>\n:reservations" as routerReservations
participant "<<middleware>>\n:auth" as middlewareAuth
participant "<<controllers>>\n:reservations" as controllersReservations
participant "<<model>>\n:Reservation" as modelReservation
database "<<MongoDB>>\n:reservations" as ReservationsDatabase

client->server ++:req.put('/api/v1/reservations/:id')\nAuthorization: Bearer <token>
server->routerReservations ++:app.use('/api/v1/reservations',reservations)
routerReservations -> middlewareAuth ++:protect()
middlewareAuth->middlewareAuth:verify token
alt token invalid
    middlewareAuth->client --:401 - Not authorized
else token valid
    middlewareAuth->routerReservations --:next()
    routerReservations -> middlewareAuth ++:authorize('admin','user')
    middlewareAuth->middlewareAuth:check user role
    alt user not authorized
        middlewareAuth->client --:403 - Not authorized
    else user authorized
        middlewareAuth->routerReservations --:next()
        routerReservations -> controllersReservations ++:updateReservation()
        controllersReservations->modelReservation ++:findById(req.params.id)
        modelReservation ->ReservationsDatabase ++: ReservationSchema
        ReservationsDatabase --> modelReservation --: reservation
        controllersReservations <-- modelReservation --:reservation
        alt reservation not found
            controllersReservations->client --:400 - Reservation not found
        else reservation found
            controllersReservations->controllersReservations:check ownership\n(reservation.user === req.user.id || admin)
            alt user not authorized to update
                controllersReservations->client --:401 - Not authorized to update
            else user authorized to update
                controllersReservations->modelReservation ++:findByIdAndUpdate(id, body, options)
                modelReservation ->ReservationsDatabase ++: ReservationSchema
                ReservationsDatabase --> modelReservation --: updatedReservation
                controllersReservations <-- modelReservation --:updatedReservation
                controllersReservations->client --:200 - Reservation updated\n{success: true, data: reservation}
            end
        end
    end
end

@enduml