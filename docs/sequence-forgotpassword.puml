@startuml ForgotPasswordSequence
skinparam participant {
    BackgroundColor lightcyan
    BorderColor black
}

actor User
participant "Auth Route" as Route
participant "Auth Controller" as Controller
participant "User Model" as Model
participant "Database" as DB
participant "Crypto Service" as Crypto
participant "Email Service" as Email

User -> Route: POST /api/auth/forgotpassword\n{email}
Route -> Controller: forgotPassword(req, res, next)

Controller -> Model: findOne({email})
Model -> DB: query user by email
DB -> Model: return user
Model -> Controller: user object or null

alt user not found
    Controller -> User: 404 - No user found with that email
else user found
    Controller -> Crypto: crypto.randomBytes(20).toString("hex")
    Crypto -> Controller: resetToken
    
    Controller -> Crypto: crypto.createHash("sha256").update(resetToken)
    Crypto -> Controller: hashedToken
    
    Controller -> Model: user.resetPasswordToken = hashedToken\nuser.resetPasswordExpire = Date.now() + 10min
    Model -> DB: save user with reset token
    DB -> Model: updated user
    
    Controller -> Controller: create resetUrl with BASE_URL from env
    Controller -> Email: sendEmail({to, subject, text})
    
    alt email sent successfully
        Email -> Controller: success
        Controller -> User: 200 - Email sent with reset link
    else email sending failed
        Email -> Controller: error
        Controller -> Model: clear resetPasswordToken & resetPasswordExpire
        Model -> DB: update user (remove tokens)
        Controller -> User: 500 - Email could not be sent
    end
end

@enduml